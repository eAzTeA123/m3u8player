<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>IPTV mit MSE</title>
  <style>
    body { background: #000; color: #fff; text-align: center; padding: 2rem; }
    video { width: 90%; max-width: 800px; border: 2px solid #0f0; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>ðŸ“º IPTV Direkt via MSE</h1>
  <video id="video" controls autoplay></video>
  <script>
    (async () => {
      const video = document.getElementById('video');
      if (!window.MediaSource) {
        video.textContent = 'Dein Browser unterstÃ¼tzt kein MSE.';
        return;
      }
      const mediaSource = new MediaSource();
      video.src = URL.createObjectURL(mediaSource);

      mediaSource.addEventListener('sourceopen', async () => {
        const sourceBuffer = mediaSource.addSourceBuffer('video/mp2t; codecs="avc1.77.30, mp4a.40.2"');

        // 1) Playlist (.m3u8) holen
        const playlistRes = await fetch('/api/stream?url=' + encodeURIComponent('https://windnew.newkso.ru/wind/premium521/mono.m3u8'));
        const playlistText = await playlistRes.text();
        const lines = playlistText.split('\n').filter(l => l && !l.startsWith('#'));

        // 2) Nacheinander Segmente laden und anhÃ¤ngen
        for (const segmentUrl of lines) {
          const absolute = new URL(segmentUrl, window.location.origin + '/api/stream?url=').href;
          const segRes = await fetch('/api/stream?url=' + encodeURIComponent(segmentUrl));
          const data = await segRes.arrayBuffer();
          await new Promise(resolve => {
            sourceBuffer.appendBuffer(data);
            sourceBuffer.addEventListener('updateend', resolve, { once: true });
          });
        }

        mediaSource.endOfStream();
      });
    })();
  </script>
</body>
</html>
